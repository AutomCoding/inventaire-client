#!/usr/bin/env bash

# Exit on error (cf http://jvns.ca/blog/2017/03/26/bash-quirks/)
set -e

echo -e '\e[0;30mupdating i18n\e[0m'
./scripts/build_i18n

echo -e '\e[0;30mupdate mentions\e[0m'
npm run update-mentions

echo -e '\e[0;30mparcel build\e[0m'
mkdir -p ./scripts/assets/bundle_reports
last_commit_hash=$(git rev-parse --short HEAD)
last_commit_date=$(git show -s --format="%ci" $COMMIT|sed 's/ .*$//')
bundle_name="${last_commit_date}_${last_commit_hash}"

export INV_PUBLIC_HOST=${INV_PUBLIC_HOST:-"https://inventaire.io"}
webpack --config webpack.config.prod.cjs | tee "./scripts/assets/bundle_reports/${bundle_name}.logs"
# tee "./scripts/assets/bundle_reports/${bundle_name}.logs"
# mv ./public/dist/report.html "./scripts/assets/bundle_reports/${bundle_name}.html"
# echo "moved bundle report to file://$PWD/scripts/assets/bundle_reports/${bundle_name}.html"

# Add assets that are kept hidden from Parcel
sed -i '/link rel="canonical"/a   <link rel="sitemap" href="/public/sitemaps/sitemapindex.xml" />' ./public/dist/index.html
# Drop blank lines
sed -i -E '/^\s*$/d' ./public/dist/index.html

echo -e '\e[0;30mgzip dist files\e[0m'
rm -f ./public/dist/*.gz
gzip -9kf ./public/dist/*

echo -e '\e[0;30mgzip assets\e[0m'
gzip -9kf public/fonts/*
gzip -9kf public/json/*
gzip -9kf public/sitemaps/*
gzip -9kf public/*.xml
gzip -9kf public/*.jsonld
gzip -9kf public/*.txt

# Run once every now and then
[ "${RANDOM:1:1}" = 9 ] && {
  echo -e '\e[0;30mgenerate sitemaps\e[0m'
  npm run generate-sitemaps
}

echo "build: done"
