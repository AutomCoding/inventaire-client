#!/usr/bin/env nodeimport { get } from 'bluereq';
/* eslint-disable
    import/no-duplicates,
    no-undef,
    no-var,
    prefer-arrow/prefer-arrow-functions,
*/
// TODO: This file was created by bulk-decaffeinate.
// Fix any style issues and re-enable lint.
import _ from 'lodash'
import { green, grey, red } from 'chalk'

import tests from './tests'

const root = require('./get_root')()
// you should have an instance of prerender listening on port 3000
// http://github.com/inventaire/prerender
const prerender = 'http://localhost:3000'
const customQuery = 'agent=build-test&__refresh=true'

const promises = []

const buildUrl = function (path) {
  let url = `${prerender}/${root}/${v.path}`
  // requires forceCacheRefresh and multiFreshness
  // prerender plugins to be activated
  url += /\?/.test(path) ? '&' : '?'
  url += customQuery

  console.log(grey('get'), grey(url))
  return url
}

const passSectionTests = (sectionTests, html) => (() => {
  const result = []
  for (const label in sectionTests) {
    const test = sectionTests[label]
    test(html)
    result.push(console.log(green('ok'), k, label))
  }
  return result
})()

const rejectEmptyHtml = function (html) {
  if (html == null) { throw new Error(`couldn't reach ${root}`) }
  return html
}

const passSectionsTests = (k, v) => get(buildUrl(v.path))
.then(_.property('body'))
.then(rejectEmptyHtml)
.then(passSectionTests.bind(null, v.tests))
.then(() => console.log(green('OK'), k))
.catch(err => {
  console.log(red(`${k} err`), err.stack)
  throw err
})

for (var k in tests) {
  var v = tests[k]
  promises.push(passSectionsTests(k, v))
}

Promise.all(promises)
.then(() => console.log(green('the build was successfully tested: ready for deploy!')))
.catch(err => console.log(red('global err'), err.stack))
